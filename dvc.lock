schema: '2.0'
stages:
  data_preprocessing:
    cmd: python scripts/data_prep_script.py
    deps:
    - path: configs/data_prep_config.yaml
      hash: md5
      md5: b93e1eefda5d0d3b8917b628b20022c2
      size: 544
    - path: data/raw/ecommerce_chatbot_train.csv
      hash: md5
      md5: 576b7399361712f30916c7c6e013564c
      size: 38349830
    - path: scripts/data_prep_script.py
      hash: md5
      md5: 2e4bd1306301c853e79aa8d4717881fc
      size: 4371
    - path: src/data_prep.py
      hash: md5
      md5: 4bdf3fdea626ae7034f8f08e6454054c
      size: 9036
    params:
      params.yaml:
        sampling.sample_description: small_dataset_for_testing_pipeline
        sampling.sample_size: 10
    outs:
    - path: data/processed/chatml_dataset_fine_tuning_dataset.jsonl
      hash: md5
      md5: be9c15fa56925b3a61c647318a285e5c
      size: 48037718
    - path: data/processed/latest_dataset_ref.json
      hash: md5
      md5: 624e712f97831aac9b9dba3365b60094
      size: 209
  fine_tuning:
    cmd: python scripts/fine_tuning_script.py  --input-ref data/processed/latest_dataset_ref.json  --output-dir
      results/  --config params.yaml  --mlflow-uri https://dagshub.com/ShenghaoisYummy/E-commerce-Chatbot.mlflow
    deps:
    - path: data/processed/chatml_dataset_fine_tuning_dataset.jsonl
      hash: md5
      md5: be9c15fa56925b3a61c647318a285e5c
      size: 48037718
    - path: data/processed/latest_dataset_ref.json
      hash: md5
      md5: 624e712f97831aac9b9dba3365b60094
      size: 209
    - path: params.yaml
      hash: md5
      md5: 7977460792ec4768e2335a12b7befb8a
      size: 1295
    - path: scripts/fine_tuning_script.py
      hash: md5
      md5: 5f9133683fe9136cd1aa6c4a024a6794
      size: 11738
    - path: src/fine_tuning.py
      hash: md5
      md5: 5b49a91161623024762e75040159bc70
      size: 16664
    params:
      params.yaml:
        data:
          dataset_path: data/processed/chatml_dataset_fine_tuning_dataset.jsonl
          test_size: 0.1
          seed: 42
          text_column: text
        lora:
          r: 16
          alpha: 32
          dropout: 0.05
          target_modules:
          - q_proj
          - k_proj
          - v_proj
          - o_proj
          - gate_proj
          - up_proj
          - down_proj
        model:
          base_model: TinyLlama/TinyLlama-1.1B-Chat-v1.0
          device:
            use_gpu: true
            precision: float32
            device_map: auto
            load_in_8bit: false
        training:
          epochs: 2
          batch_size: 4
          gradient_accumulation_steps: 4
          learning_rate: 0.0002
          weight_decay: 0.01
          warmup_steps: 100
          max_length: 1024
          fp16: true
          bf16: false
          eval_strategy: epoch
          save_strategy: epoch
          save_total_limit: 2
          load_best_model_at_end: true
    outs:
    - path: results/fine_tuned_model_location.json
      hash: md5
      md5: 7df1763e86a2d0dfba444cf45e55b8f8
      size: 255
  evaluation:
    cmd: python scripts/evaluation_script.py  --eval-dataset-path data/evaluation/chatml_dataset_eval_dataset.jsonl
      --model-artifact-path results/fine_tuned_model_location.json --output-dir results/evaluations
      --config params.yaml --mlflow-uri https://dagshub.com/ShenghaoisYummy/E-commerce-Chatbot.mlflow
    deps:
    - path: data/evaluation/chatml_dataset_eval_dataset.jsonl
      hash: md5
      md5: c82de4b5f1eb6967b0e573da3411cd32
      size: 5351351
    - path: results/fine_tuned_model_location.json
      hash: md5
      md5: 7df1763e86a2d0dfba444cf45e55b8f8
      size: 255
    - path: scripts/evaluation_script.py
      hash: md5
      md5: ea7607970c5ba933c2d7f3e0b5a0aae9
      size: 7093
    - path: src/evaluation.py
      hash: md5
      md5: 6adf159ba610c26943d6a863783fa83a
      size: 5806
    params:
      params.yaml:
        evaluation:
          use_dagshub: true
          batch_size: 4
          max_length: 512
          num_beams: 4
          metrics:
          - bleu
          - rouge
    outs:
    - path: results/evaluations
      hash: md5
      md5: bb9baac9e95b3741cc7c72ec45aa6cd8.dir
      size: 1430
      nfiles: 2
